# Описание фичи: Арена для групп

В игре появляется новая функциональность — Арена, на которой группы могут сражаться друг с другом. Одна группа может вызвать другую на бой, указав тег группы-противника, ставку (только деньги из казны группы) и максимальное количество участников (не менее 5). Противник выбирается по тегу группы. После вызова принимающей стороне приходит уведомление в групповой чат, и любой участник может принять или отклонить вызов. Если вызов принят, обе стороны собирают команду: в каждой группе появляется кнопка "Участвовать", на которую могут нажимать участники, чтобы записаться в команду. Как только набралось нужное количество участников, любой участник может нажать кнопку "Группа собрана". Только после этого бой может начаться. Нельзя бросить вызов группе, в которой меньше 5 человек. Как только обе команды собраны, проводится бой по существующей механике (см. `TwoPersonageTeamsBattle`). Победитель получает всю ставку в казну группы, а также изменяется ELO-рейтинг групп и статистика боёв на арене. Участвовать в боях на арене можно не чаще, чем раз в 6 часов для каждой группы. При большом разрыве ELO между группами бой невозможен. В случае сбоя или отмены боя ставки возвращаются, группы получают уведомление об ошибке. Все новые сообщения реализуются только на русском языке.

---

# Подробный план реализации фичи "Арена для групп"

Этот план предназначен для стажёра. Следуй шаг за шагом, не пропускай детали. Если что-то не понятно — обязательно спрашивай!

---

## 1. Проектирование и подготовка

### 1.1. Создание таблицы истории боёв на арене

1. Открой папку с миграциями базы данных (`src/main/resources/migrations/`).
2. Создай новый файл миграции для создания таблицы, например:  
   `202X-XX-XX_01_create-arena-battle-history-table.xml`
3. В файле опиши создание таблицы, например:

   ```xml
   <changeSet id="create-arena-battle-history" author="your_name">
     <createTable tableName="arena_battle_history">
       <column name="id" type="BIGINT" autoIncrement="true" primaryKey="true"/>
       <column name="initiator_group_id" type="BIGINT"/>
       <column name="receiver_group_id" type="BIGINT"/>
       <column name="start_time" type="TIMESTAMP"/>
       <column name="end_time" type="TIMESTAMP"/>
       <column name="bet" type="BIGINT"/>
       <column name="winner_group_id" type="BIGINT"/>
       <column name="status" type="VARCHAR(32)"/>
       <column name="initiator_team" type="VARCHAR(512)"/>
       <column name="receiver_team" type="VARCHAR(512)"/>
       <column name="initiator_elo_before" type="INT"/>
       <column name="receiver_elo_before" type="INT"/>
       <column name="initiator_elo_after" type="INT"/>
       <column name="receiver_elo_after" type="INT"/>
     </createTable>
   </changeSet>
   ```
   > **Примечание:** Если не уверен в типах данных — посмотри, как устроены другие таблицы для боёв.

---

### 1.2. Добавление новых полей в таблицу групп

1. В той же папке миграций создай файл, например:  
   `202X-XX-XX_02_add-arena-fields-to-group-table.xml`
2. Добавь новые поля:
   - `arena_elo` (INT, по умолчанию 1000)
   - `arena_cooldown_until` (TIMESTAMP, может быть null)

   ```xml
   <changeSet id="add-arena-fields-to-group" author="your_name">
     <addColumn tableName="group">
       <column name="arena_elo" type="INT" defaultValueNumeric="1000"/>
       <column name="arena_cooldown_until" type="TIMESTAMP"/>
     </addColumn>
   </changeSet>
   ```

---

### 1.3. Обновление моделей и репозиториев

1. Найди Java-классы, которые отвечают за группы и бои (например, `Group.java`, `GroupDao.java`, `BattleHistory.java`).
2. Добавь новые поля в соответствующие классы:
   - В модель группы (`Group.java`): `arenaElo`, `arenaCooldownUntil`
   - Создай новую модель для истории боёв на арене (`ArenaBattleHistory.java`)
3. Создай/обнови DAO или репозиторий для работы с ареной:
   - Методы для создания, обновления, поиска истории боёв
   - Методы для работы с ELO и кулдауном

---

## 2. Бизнес-логика

### 2.1. Инициация боя на арене

1. Добавь новую команду для Telegram-бота, например:  
   `/arena_challenge <tag_группы> <ставка> <число_участников>`
2. В обработчике команды:
   - Проверь, что у группы-инициатора достаточно денег в казне
   - Проверь, что у группы нет активного кулдауна (поле `arena_cooldown_until`)
   - Проверь, что разница ELO между группами не превышает допустимый порог (например, 300)
   - Проверь, что группа не участвует в другом бою на арене
   - Проверь, что в группе-противнике не менее 5 человек
   - Если всё хорошо — создай запись о приглашении на арену и спиши ставку с казны инициатора

---

### 2.2. Обработка приглашения

1. После создания приглашения отправь сообщение в групповой чат принимающей группы:
   - Сообщи, кто вызвал на арену, размер ставки, количество участников
   - Добавь кнопки "Принять" и "Отклонить" (или команды `/arena_accept`, `/arena_decline`)
2. Любой участник принимающей группы может принять или отклонить вызов:
   - Если отклонено — верни ставку инициатору, обнови статус приглашения
   - Если принято — спиши ставку с казны принимающей группы, переходи к сбору команды

---

### 2.3. Сбор команды и подтверждение готовности

1. После принятия вызова в обеих группах появляется кнопка "Участвовать". Любой участник может нажать, чтобы записаться в команду.
2. Как только набралось нужное количество участников, появляется кнопка "Группа собрана". Любой участник может её нажать.
3. Как только обе группы собраны, начинается бой.
4. Если команда не собрана за, например, 5 минут — бой отменяется, ставки возвращаются обеим группам, статус обновляется.

---

### 2.4. Проведение боя

1. Когда обе команды готовы, создай объекты участников (`BattlePersonage`) для каждой команды.
2. Используй класс `TwoPersonageTeamsBattle` для проведения боя.
3. Определи победителя (см. результат метода battle).
4. Обнови ELO обеих групп по формуле ELO (можно найти в интернете или спросить у тимлида).
5. Переведи ставку победителю (добавь в казну группы).
6. Обнови историю боя и статистику групп (количество побед/поражений на арене, ELO).

---

### 2.5. Ограничения и защита

1. Перед началом боя ещё раз проверь разницу ELO.
2. После боя установи кулдаун 6 часов для обеих групп (запиши в поле `arena_cooldown_until` текущее время + 6 часов).
3. Если группа распускается или не отвечает на приглашение — вызов отменяется, ставка возвращается инициатору, статус обновляется.

---

### 2.6. Обработка ошибок

1. Если на любом этапе произошла ошибка (например, сбой сервера, не удалось провести бой):
   - Верни ставки обеим группам
   - Отправь сообщение об ошибке в групповые чаты обеих групп
   - Обнови статус приглашения/боя как "отменён"

---

## 3. Интеграция с Telegram/чат-ботом

### 3.1. Реализация команд

1. Добавь новые команды и кнопки для арены:
   - `/arena_challenge` — вызов на арену
   - `/arena_accept` — принять вызов
   - `/arena_decline` — отклонить вызов
   - Кнопка "Участвовать" — записаться в команду
   - Кнопка "Группа собрана" — подтвердить, что команда готова
2. Для каждой команды и кнопки реализуй обработчик в коде бота.
3. Проверь, что команды работают только для участников соответствующих групп.

---

### 3.2. Уведомления

1. Реализуй отправку сообщений в групповые чаты:
   - О вызове на арену (с деталями)
   - О принятии/отклонении вызова
   - О начале боя
   - О результате боя (кто победил, сколько ELO изменилось, кто получил ставку)
   - Об ошибках (если что-то пошло не так)

---

### 3.3. Локализация

1. Все новые сообщения и тексты должны быть только на русском языке.
2. Добавь новые строки в соответствующие toml-файлы локализации (например, `src/main/resources/localization/ru/`).
3. Используй существующую систему локализации для вывода сообщений.

---

## Общие советы

- Всегда смотри, как реализованы похожие механики в проекте (например, групповые бои, дуэли, события).
- Не стесняйся спрашивать, если что-то не понятно.
- После каждого крупного шага показывай результат тимлиду или наставнику.

--- 